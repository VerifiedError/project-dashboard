/**
 * FILE-REF: DB-001-20251128
 *
 * @file schema.prisma
 * @description Database schema for DevOps Resource Dashboard
 * @category Database
 * @created 2025-11-28
 * @modified 2025-11-28
 *
 * @changelog
 * - 2025-11-28 - Initial database schema with all models (CHG-001)
 */

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users - Authentication and user management
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hashed password
  email     String?  @unique
  name      String?
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects  Project[]
  apiKeys   ApiKey[]
  changelog ChangelogEntry[]

  @@index([username])
  @@index([email])
}

enum UserRole {
  USER
  ADMIN
}

// Projects - User's custom projects
model Project {
  id          String   @id @default(cuid())
  userId      String   // Owner of the project
  name        String
  description String?
  repository  String?  // GitHub/GitLab URL
  status      ProjectStatus @default(ACTIVE)
  tags        String[] // Array of tags for categorization
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ngrokTunnels    NgrokTunnel[]
  vercelProjects  VercelProject[]
  neonDatabases   NeonDatabase[]
  upstashDatabases UpstashDatabase[]
  changelog       ChangelogEntry[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  PAUSED
}

// ngrok Tunnels
model NgrokTunnel {
  id              String   @id @default(cuid())
  ngrokId         String   @unique // ngrok's internal ID
  publicUrl       String
  protocol        String   // http, https, tcp, tls
  forwardingAddr  String   // localhost:3000
  region          String?
  connectionCount Int      @default(0)
  bytesTransferred BigInt  @default(0)
  status          TunnelStatus @default(ACTIVE)
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([lastSyncedAt])
}

enum TunnelStatus {
  ACTIVE
  INACTIVE
  ERROR
}

// Vercel Projects
model VercelProject {
  id              String   @id @default(cuid())
  vercelId        String   @unique // Vercel's project ID
  name            String
  framework       String?  // nextjs, react, vue, etc.
  productionUrl   String?
  gitProvider     String?  // github, gitlab, bitbucket
  gitRepo         String?
  latestDeployment Json?   // Store latest deployment info
  buildStatus     BuildStatus @default(READY)
  lastDeployedAt  DateTime?
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([buildStatus])
  @@index([lastSyncedAt])
}

enum BuildStatus {
  READY
  BUILDING
  ERROR
  QUEUED
  CANCELED
}

// Neon Databases
model NeonDatabase {
  id              String   @id @default(cuid())
  neonProjectId   String   @unique // Neon's project ID
  projectName     String
  databaseName    String
  region          String
  postgresVersion String
  connectionUri   String   // Encrypted
  storageUsageGB  Float    @default(0)
  computeHours    Float    @default(0)
  branchCount     Int      @default(1)
  status          DatabaseStatus @default(ACTIVE)
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([lastSyncedAt])
}

enum DatabaseStatus {
  ACTIVE
  SUSPENDED
  ERROR
}

// Upstash Databases
model UpstashDatabase {
  id              String   @id @default(cuid())
  upstashId       String   @unique // Upstash's database/cluster ID
  name            String
  type            UpstashType // REDIS or KAFKA
  region          String
  endpoint        String
  port            Int
  tlsEnabled      Boolean  @default(true)
  totalCommands   BigInt   @default(0)
  storageUsedMB   Float    @default(0)
  status          DatabaseStatus @default(ACTIVE)
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([status])
  @@index([lastSyncedAt])
}

enum UpstashType {
  REDIS
  KAFKA
}

// Changelog Entries
model ChangelogEntry {
  id          String   @id @default(cuid())
  refNumber   String   @unique // e.g., "CHG-001", "CHG-002"
  title       String
  description String
  category    ChangeCategory
  severity    ChangeSeverity @default(MINOR)
  fileChanges Json?    // Array of files changed with their ref numbers
  author      String   @default("System")
  createdAt   DateTime @default(now())

  // Relations
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([category])
  @@index([createdAt(sort: Desc)])
}

enum ChangeCategory {
  FEATURE
  BUGFIX
  IMPROVEMENT
  REFACTOR
  DOCUMENTATION
  CONFIGURATION
  DATABASE
  API
  UI
}

enum ChangeSeverity {
  CRITICAL  // Breaking changes, major features
  MAJOR     // New features, significant improvements
  MINOR     // Small improvements, bug fixes
  PATCH     // Tiny fixes, typos
}

// API Keys Storage (encrypted)
model ApiKey {
  id          String   @id @default(cuid())
  userId      String   // Owner of the API key
  service     ServiceType
  keyValue    String   // Encrypted
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, service]) // Each user can have one key per service
  @@index([service])
  @@index([userId])
}

enum ServiceType {
  NGROK
  VERCEL
  NEON
  UPSTASH
  GITHUB
}

// System Settings
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// Debug Logs - Comprehensive error and debug tracking
model DebugLog {
  id          String   @id @default(cuid())
  refId       String   @unique // e.g., "DBG-20251128-A1B2C3"
  timestamp   DateTime @default(now())
  level       LogLevel
  category    LogCategory
  message     String   @db.Text
  details     Json?    // Additional context and parameters
  stack       String?  @db.Text // Error stack trace
  userId      String?
  component   String?  // Component/file where error occurred
  action      String?  // Action being performed
  file        String?  // File path
  line        Int?     // Line number
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())

  @@index([refId])
  @@index([level])
  @@index([category])
  @@index([timestamp(sort: Desc)])
  @@index([userId])
  @@index([resolved])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

enum LogCategory {
  ENCRYPTION
  API_KEY
  DATABASE
  API_INTEGRATION
  AUTH
  VALIDATION
  SYSTEM
  UI
}
